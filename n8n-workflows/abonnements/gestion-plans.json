{
  "name": "Gestion des Plans - Notifications",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "plan-modified",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "webhook-plan-modified",
      "name": "Webhook Plan Modifi√©",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "plan-modified"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.planName }}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "validate-data",
      "name": "Valider Donn√©es",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "fromEmail": "notifications@talosprimes.com",
        "toEmail": "admin@talosprimes.com",
        "subject": "üéõÔ∏è Plan Modifi√©: {{ $json.planName }}",
        "emailType": "html",
        "message": `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
    .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
    .info-box { background: white; border-left: 4px solid #667eea; padding: 15px; margin: 15px 0; border-radius: 5px; }
    .changes { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px; }
    .footer { text-align: center; margin-top: 20px; color: #6c757d; font-size: 12px; }
    .label { font-weight: bold; color: #667eea; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéõÔ∏è Modification de Plan</h1>
      <p>Un plan d'abonnement a √©t√© modifi√©</p>
    </div>
    <div class="content">
      <div class="info-box">
        <p><span class="label">üì¶ Plan:</span> {{ $json.planName }}</p>
        <p><span class="label">üÜî Plan ID:</span> {{ $json.planId }}</p>
        <p><span class="label">üë§ Modifi√© par:</span> {{ $json.modifiedBy }}</p>
        <p><span class="label">üìÖ Date:</span> {{ $json.modifiedAt }}</p>
      </div>

      <div class="changes">
        <h3>üìù Modifications effectu√©es:</h3>
        <pre style="background: white; padding: 15px; border-radius: 5px; overflow-x: auto;">{{ JSON.stringify($json.changes, null, 2) }}</pre>
      </div>

      <p style="margin-top: 20px;">
        <strong>‚ö†Ô∏è Actions recommand√©es:</strong>
      </p>
      <ul>
        <li>V√©rifier que les modifications sont conformes</li>
        <li>V√©rifier l'impact sur les clients existants</li>
        <li>Mettre √† jour la documentation si n√©cessaire</li>
        <li>Communiquer aux clients si prix ou quotas changent</li>
      </ul>

      <p style="text-align: center; margin-top: 30px;">
        <a href="https://www.talosprimes.com/platform/plans" 
           style="background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block;">
          üéõÔ∏è Voir la Gestion des Plans
        </a>
      </p>
    </div>
    <div class="footer">
      <p>Talos Prime - Gestion des Abonnements</p>
      <p>Cet email est envoy√© automatiquement lors de modifications de plans.</p>
    </div>
  </div>
</body>
</html>`
      },
      "id": "send-email-admin",
      "name": "Email Admin",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [650, 200],
      "credentials": {
        "smtp": {
          "id": "resend_smtp",
          "name": "Resend SMTP"
        }
      }
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "postMessage",
        "channel": "#admin-notifications",
        "text": "üéõÔ∏è *Plan Modifi√©: {{ $json.planName }}*\n\nüìã *Plan ID:* `{{ $json.planId }}`\nüë§ *Modifi√© par:* {{ $json.modifiedBy }}\nüìÖ *Date:* {{ $json.modifiedAt }}\n\nüìù *Modifications:*\n```\n{{ JSON.stringify($json.changes, null, 2) }}\n```\n\nüîó <https://www.talosprimes.com/platform/plans|Voir la Gestion des Plans>",
        "otherOptions": {}
      },
      "id": "send-slack-notification",
      "name": "Slack Notification",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 1,
      "position": [650, 300],
      "credentials": {
        "slackApi": {
          "id": "slack_api",
          "name": "Slack API"
        }
      }
    },
    {
      "parameters": {
        "authentication": "oAuth2",
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "ADMIN_USER_ID",
          "mode": "id"
        },
        "text": "üéõÔ∏è *Plan Modifi√©: {{ $json.planName }}*\n\nüì¶ Plan: {{ $json.planName }}\nüë§ Par: {{ $json.modifiedBy }}\nüìÖ Date: {{ $json.modifiedAt }}\n\nüìù Voir les d√©tails sur le dashboard admin.",
        "otherOptions": {}
      },
      "id": "send-telegram",
      "name": "Telegram (Optionnel)",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [650, 400],
      "credentials": {
        "telegramApi": {
          "id": "telegram_bot",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "schema": "public",
        "table": "plan_modification_history",
        "columns": "plan_id,modified_by,changes,modified_at",
        "additionalFields": {}
      },
      "id": "log-to-database",
      "name": "Log en BDD (Historique)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [850, 300],
      "credentials": {
        "postgres": {
          "id": "supabase_postgres",
          "name": "Supabase PostgreSQL"
        }
      },
      "executeOnce": false
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": true, \"message\": \"Notifications envoy√©es\", \"timestamp\": $now } }}"
      },
      "id": "respond-success",
      "name": "R√©ponse Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"success\": false, \"error\": \"Donn√©es invalides\" } }}",
        "responseCode": 400
      },
      "id": "respond-error",
      "name": "Erreur Validation",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [650, 500]
    }
  ],
  "connections": {
    "Webhook Plan Modifi√©": {
      "main": [
        [
          {
            "node": "Valider Donn√©es",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valider Donn√©es": {
      "main": [
        [
          {
            "node": "Email Admin",
            "type": "main",
            "index": 0
          },
          {
            "node": "Slack Notification",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telegram (Optionnel)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erreur Validation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Admin": {
      "main": [
        [
          {
            "node": "Log en BDD (Historique)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Notification": {
      "main": [
        [
          {
            "node": "Log en BDD (Historique)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram (Optionnel)": {
      "main": [
        [
          {
            "node": "Log en BDD (Historique)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log en BDD (Historique)": {
      "main": [
        [
          {
            "node": "R√©ponse Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1.0.0",
  "id": "gestion-plans",
  "meta": {
    "instanceId": "talos-prime-n8n"
  },
  "tags": [
    {
      "createdAt": "2025-12-31T00:00:00.000Z",
      "updatedAt": "2025-12-31T00:00:00.000Z",
      "id": "plans",
      "name": "plans"
    },
    {
      "createdAt": "2025-12-31T00:00:00.000Z",
      "updatedAt": "2025-12-31T00:00:00.000Z",
      "id": "notifications",
      "name": "notifications"
    }
  ]
}

